{"version":3,"file":"index-chunk.js","sources":["../../src/threads/index.ts","../../src/ts/utils.ts"],"sourcesContent":["import type { WorkerOptions } from 'node:worker_threads';\nimport { Worker, isMainThread, parentPort, SHARE_ENV } from 'node:worker_threads';\n\nconst port = parentPort!;\nif (!isMainThread && !port) {\n  throw new ReferenceError('Failed to receive parent message port');\n}\n\nconst enum MainMessageCodes {\n  Start = 'START',\n  Close = 'CLOSE',\n  Pull = 'PULL',\n}\n\ninterface MainMessage {\n  id?: number;\n  kind: MainMessageCodes;\n  data?: any;\n}\n\nconst enum ThreadMessageCodes {\n  Next = 'NEXT',\n  Throw = 'THROW',\n  Return = 'RETURN',\n}\n\ninterface ThreadMessage {\n  id?: number;\n  kind: ThreadMessageCodes;\n  data?: any;\n}\n\nconst workerOpts: WorkerOptions = {\n  env: SHARE_ENV,\n  stderr: false,\n  stdout: false,\n  stdin: false,\n};\n\nconst asyncIteratorSymbol = (): typeof Symbol.asyncIterator =>\n  (typeof Symbol === 'function' && Symbol.asyncIterator) || ('@@asyncIterator' as any);\n\n/** Capture the stack above the caller */\nfunction captureStack(): NodeJS.CallSite[] {\n  const _error: any = new Error();\n  const _prepareStackTrace = Error.prepareStackTrace;\n  try {\n    let stack: NodeJS.CallSite[] | undefined;\n    Error.prepareStackTrace = (_error, _stack) => (stack = _stack);\n    Error.captureStackTrace(_error);\n    if (!_error.stack) throw _error;\n    return (stack && stack.slice(2)) || [];\n  } finally {\n    Error.prepareStackTrace = _prepareStackTrace;\n  }\n}\n\nexport interface Generator<Args extends readonly any[], Next> {\n  // TODO: Update to support for AsyncGenerator interface\n  (...args: Args): AsyncIterableIterator<Next>;\n}\n\nfunction main<Args extends readonly any[], Next>(url: string | URL): Generator<Args, Next> {\n  let worker: Worker;\n  let ids = 0;\n  return (...args: Args) => {\n    if (!worker) {\n      worker = new Worker(url, workerOpts);\n      worker.unref();\n    }\n\n    const id = ++ids | 0;\n    const buffer: ThreadMessage[] = [];\n\n    let started = false;\n    let ended = false;\n    let pulled = false;\n    let resolve: ((value: IteratorResult<Next>) => void) | void;\n    let reject: ((error: any) => void) | void;\n\n    function cleanup() {\n      ended = true;\n      resolve = undefined;\n      reject = undefined;\n      worker.removeListener('message', receiveMessage);\n      worker.removeListener('error', receiveError);\n    }\n\n    function sendMessage(kind: MainMessageCodes) {\n      worker.postMessage({ id, kind });\n    }\n\n    function receiveError(error: any) {\n      cleanup();\n      buffer.length = 1;\n      buffer[0] = {\n        id,\n        kind: ThreadMessageCodes.Throw,\n        data: error,\n      };\n    }\n\n    function receiveMessage(data: unknown) {\n      const message: ThreadMessage | null =\n        data && typeof data === 'object' && 'kind' in data ? (data as ThreadMessage) : null;\n      if (!message) {\n        return;\n      } else if (reject && message.kind === ThreadMessageCodes.Throw) {\n        reject(message.data);\n        cleanup();\n      } else if (resolve && message.kind === ThreadMessageCodes.Return) {\n        resolve({ done: true, value: message.data });\n        cleanup();\n      } else if (resolve && message.kind === ThreadMessageCodes.Next) {\n        pulled = false;\n        resolve({ done: false, value: message.data });\n      } else if (\n        message.kind === ThreadMessageCodes.Throw ||\n        message.kind === ThreadMessageCodes.Return\n      ) {\n        buffer.push(message);\n        cleanup();\n      } else if (message.kind === ThreadMessageCodes.Next) {\n        buffer.push(message);\n        pulled = false;\n      }\n    }\n\n    return {\n      async next() {\n        if (!started) {\n          started = true;\n          worker.addListener('message', receiveMessage);\n          worker.addListener('error', receiveError);\n          worker.postMessage({\n            id,\n            kind: MainMessageCodes.Start,\n            data: args,\n          });\n        }\n        if (ended && !buffer.length) {\n          return { done: true } as IteratorReturnResult<any>;\n        } else if (!ended && !pulled && buffer.length <= 1) {\n          pulled = true;\n          sendMessage(MainMessageCodes.Pull);\n        }\n        const message = buffer.shift();\n        if (message && message.kind === ThreadMessageCodes.Throw) {\n          cleanup();\n          throw message.data;\n        } else if (message && message.kind === ThreadMessageCodes.Return) {\n          cleanup();\n          return { value: message.data, done: true };\n        } else if (message && message.kind === ThreadMessageCodes.Next) {\n          return { value: message.data, done: false };\n        } else {\n          return new Promise((_resolve, _reject) => {\n            resolve = (value) => {\n              resolve = undefined;\n              reject = undefined;\n              _resolve(value);\n            };\n            reject = (error) => {\n              resolve = undefined;\n              reject = undefined;\n              _reject(error);\n            };\n          });\n        }\n      },\n      async return() {\n        if (!ended) {\n          cleanup();\n          sendMessage(MainMessageCodes.Close);\n        }\n        return { done: true } as IteratorReturnResult<any>;\n      },\n      [asyncIteratorSymbol()]() {\n        return this;\n      },\n    };\n  };\n}\n\nfunction thread<Args extends readonly any[], Next>(\n  message: MainMessage,\n  generator: Generator<Args, Next>\n): void {\n  if (message.kind !== MainMessageCodes.Start) return;\n  const id = message.id;\n  const iterator = generator(...(message.data as any));\n\n  let ended = false;\n  let pulled = false;\n  let looping = false;\n\n  function cleanup() {\n    ended = true;\n    port.removeListener('message', receiveMessage);\n  }\n\n  async function sendMessage(kind: ThreadMessageCodes, data?: any) {\n    try {\n      port.postMessage({ id, kind, data });\n    } catch (error) {\n      cleanup();\n      if (iterator.throw) {\n        let result = await iterator.throw();\n        if (result.done === false && iterator.return) {\n          result = await iterator.return();\n          sendMessage(ThreadMessageCodes.Return, result.value);\n        } else {\n          sendMessage(ThreadMessageCodes.Return, result.value);\n        }\n      } else {\n        sendMessage(ThreadMessageCodes.Return);\n      }\n    }\n  }\n\n  async function receiveMessage(data: unknown) {\n    const message: MainMessage | null =\n      data && typeof data === 'object' && 'kind' in data ? (data as MainMessage) : null;\n    let next: IteratorResult<Next>;\n    if (!message) {\n      return;\n    } else if (message.kind === MainMessageCodes.Close) {\n      cleanup();\n      if (iterator.return) iterator.return();\n    } else if (message.kind === MainMessageCodes.Pull && looping) {\n      pulled = true;\n    } else if (message.kind === MainMessageCodes.Pull) {\n      for (pulled = looping = true; pulled && !ended; ) {\n        try {\n          if ((next = await iterator.next()).done) {\n            cleanup();\n            if (iterator.return) next = await iterator.return();\n            sendMessage(ThreadMessageCodes.Return, next.value);\n          } else {\n            pulled = false;\n            sendMessage(ThreadMessageCodes.Next, next.value);\n          }\n        } catch (error) {\n          cleanup();\n          sendMessage(ThreadMessageCodes.Throw, error);\n        }\n      }\n      looping = false;\n    }\n  }\n\n  port.addListener('message', receiveMessage);\n}\n\nexport function expose<Args extends readonly any[], Return>(\n  generator: Generator<Args, Return>\n): Generator<Args, Return> {\n  if (isMainThread) {\n    const call = captureStack()[0];\n    const file = call && call.getFileName();\n    if (!file) throw new ReferenceError('Captured stack trace is empty');\n    const url = file.startsWith('file://') ? new URL(file) : file;\n    return main(url);\n  } else {\n    port.addListener('message', (data) => {\n      const message: MainMessage | null =\n        data && typeof data === 'object' && 'kind' in data ? (data as MainMessage) : null;\n      if (message) thread(message, generator);\n    });\n    return generator;\n  }\n}\n","import type { SourceFile } from 'typescript';\n\nexport interface Position {\n  line: number;\n  col: number;\n  endLine: number | undefined;\n  endColumn: number | undefined;\n}\n\nexport const getFilePosition = (\n  file: SourceFile,\n  start?: number | undefined,\n  length?: number | undefined\n): Position => {\n  const output: Position = { line: 1, col: 1, endLine: undefined, endColumn: undefined };\n  if (start) {\n    let lineAndChar = file.getLineAndCharacterOfPosition(start);\n    output.line = lineAndChar.line + 1;\n    output.col = lineAndChar.character + 1;\n    if (length) {\n      lineAndChar = file.getLineAndCharacterOfPosition(start + length - 1);\n      output.endLine = lineAndChar.line + 1;\n      output.endColumn = lineAndChar.character + 1;\n    }\n  }\n  return output;\n};\n"],"names":["port","parentPort","isMainThread","ReferenceError","MainMessageCodes","ThreadMessageCodes","workerOpts","env","SHARE_ENV","stderr","stdout","stdin","asyncIteratorSymbol","Symbol","asyncIterator","expose","generator","call","captureStack","_error","Error","_prepareStackTrace","prepareStackTrace","stack","_stack","captureStackTrace","slice","file","getFileName","main","url","worker","ids","args","Worker","unref","id","buffer","started","ended","pulled","resolve","reject","cleanup","undefined","removeListener","receiveMessage","receiveError","sendMessage","kind","postMessage","error","length","Throw","data","message","Return","done","value","Next","push","next","addListener","Start","Pull","shift","Promise","_resolve","_reject","return","Close","this","startsWith","URL","thread","iterator","looping","async","throw","result","getFilePosition","start","output","line","col","endLine","endColumn","lineAndChar","getLineAndCharacterOfPosition","character"],"mappings":"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"}